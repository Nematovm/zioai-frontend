<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZiyoAI — Sign Up</title>
    <link rel="website icon" type="png" href="../IMG/Logo/ZiyoAILogo.png" />
    <link rel="stylesheet" href="../Static/auth.css" />
    <link rel="stylesheet" href="../CSS/main.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <!-- Spinner -->
    <div class="spinner-wrapper">
      <div class="spinner-grow" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Back to home -->
    <a class="back-home" href="../index.html"><i class="bi bi-chevron-left"></i></a>

    <div class="auth-container">
      <div class="main-section">
        <div class="nav-left login-logo">
          <img src="../IMG/Logo/ZiyoAILogo.png" alt="" />
          <a class="navbar-brand"><h3 class="nav-title">iyoAI</h3></a>
        </div>
        <h4>Sayohatingizni boshlang</h4>
        <p>Boshlash uchun hisob yarating</p>
      </div>

      <div class="auth-card" id="login-form">
        <!-- Error Alert -->
        <div id="errorAlert" style="display:none; background:#fee; color:#c33; padding:12px; border-radius:8px; margin-bottom:15px; font-size:14px;"></div>
        <!-- Success Alert -->
        <div id="successAlert" style="display:none; background:#efe; color:#3c3; padding:12px; border-radius:8px; margin-bottom:15px; font-size:14px;"></div>
        <!-- Warning Alert -->
        <div id="warningAlert" style="display:none; background:#fff3cd; color:#856404; padding:12px; border-radius:8px; margin-bottom:15px; font-size:14px;"></div>

        <div>
          <div class="input-box">
            <input type="text" id="username" name="username" placeholder=" " required />
            <label>Username</label>
          </div>

          <div class="input-box">
            <input type="email" id="email" name="email" placeholder=" " required />
            <label>Email</label>
          </div>

          <div class="input-box">
            <input type="password" id="password" name="password" placeholder=" " required />
            <label>Parol</label>
          </div>

          <button class="btn-primary" type="button" id="signupBtn" onclick="handleSignup()">
            Ro'yxatdan o'tish
          </button>

          <!-- Divider -->
          <div style="margin:20px 0; text-align:center; color:#6b7280; font-size:14px;">
            <span style="display:inline-block; width:100%; position:relative;">
              <span style="background:white; padding:0 10px; position:relative; z-index:1;">or</span>
              <span style="position:absolute; top:50%; left:0; right:0; height:1px; background:#e5e7eb; z-index:0;"></span>
            </span>
          </div>

          <!-- Google Sign-in -->
          <button
            type="button"
            onclick="handleGoogleSignUp()"
            style="width:100%; padding:12px; background:white; border:2px solid #e5e7eb; border-radius:10px; cursor:pointer; font-size:15px; font-weight:600; color:#374151; display:flex; align-items:center; justify-content:center; gap:10px; transition:all 0.3s ease;"
            onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'"
            onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'"
          >
            <svg width="20" height="20" viewBox="0 0 48 48">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
            </svg>
            Google orqali davom etish
          </button>
        </div>

        <p class="switch-link">
          Allaqachon hisobingiz bormi? <a href="./login.html">Kirish</a>
        </p>
      </div>
    </div>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        updateProfile,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // =============================================
      // ⚙️ SOZLAMALAR — O'zgartiring!
      // =============================================
    const EMAILJS_PUBLIC_KEY  = "EOVuFtynDt_B3cg5v";
    const EMAILJS_SERVICE_ID  = "service_o80q31v";
    const EMAILJS_TEMPLATE_ID = "template_8qiy9hu";
      // =============================================

      const firebaseConfig = {
        apiKey: "AIzaSyA_w0n84YFtUYZgZodCn52lfYiqkL6v1HM",
        authDomain: "zioai-96e9f.firebaseapp.com",
        projectId: "zioai-96e9f",
        storageBucket: "zioai-96e9f.firebasestorage.app",
        messagingSenderId: "766076125152",
        appId: "1:766076125152:web:9cd609efb7895386547585",
        measurementId: "G-2EDVXFZFHQ",
      };

      const app  = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // EmailJS init
      emailjs.init(EMAILJS_PUBLIC_KEY);

      // Agar allaqachon logged in bo'lsa
      onAuthStateChanged(auth, (user) => {
        if (user && sessionStorage.getItem("ziyo_verified") === "true") {
          window.location.href = "./dashboard.html";
        }
      });

      // 6 xonali tasodifiy kod yaratish
      function generateOTP() {
        return Math.floor(100000 + Math.random() * 900000).toString();
      }

      // EmailJS orqali kod yuborish
      async function sendOTPEmail(toEmail, toName, otp) {
        const expireTime = new Date(Date.now() + 10 * 60 * 1000).toLocaleTimeString("uz-UZ", {
          hour: "2-digit",
          minute: "2-digit",
        });

        return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
          to_name:    toName,
          to_email:   toEmail,
          otp_code:   otp,
          expire_time: expireTime,
          app_name:   "ZiyoAI",
        });
      }

      // Ro'yxatdan o'tish
      window.handleSignup = async function () {
        const username   = document.getElementById("username").value.trim();
        const email      = document.getElementById("email").value.trim();
        const password   = document.getElementById("password").value;
        const signupBtn  = document.getElementById("signupBtn");

        hideAlerts();

        if (!username || !email || !password) {
          showError("Iltimos, barcha maydonlarni to'ldiring!");
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showError("Iltimos, to'g'ri email kiriting!");
          return;
        }

        if (password.length < 6) {
          showError("Parol kamida 6 ta belgidan iborat bo'lishi kerak!");
          return;
        }

        signupBtn.disabled = true;
        signupBtn.textContent = "Yaratilmoqda...";

        try {
          // Firebase'da hisob yaratish
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(userCredential.user, { displayName: username });

          // OTP yaratish
          const otp        = generateOTP();
          const otpExpiry  = Date.now() + 10 * 60 * 1000; // 10 daqiqa

          // Sessionga saqlash
          sessionStorage.setItem("ziyo_otp",      otp);
          sessionStorage.setItem("ziyo_otp_exp",  otpExpiry);
          sessionStorage.setItem("ziyo_email",    email);
          sessionStorage.setItem("ziyo_username", username);
          sessionStorage.setItem("ziyo_uid",      userCredential.user.uid);

          // Email yuborish
          signupBtn.textContent = "Kod yuborilmoqda...";
          await sendOTPEmail(email, username, otp);

          showSuccess(`✅ Tasdiqlash kodi ${email} ga yuborildi!`);

          // verify-email sahifasiga o'tish
          setTimeout(() => {
            window.location.href = "./verify-email.html";
          }, 1500);

        } catch (error) {
          console.error("Signup error:", error);

          let msg = "Xatolik yuz berdi!";
          if (error.code === "auth/email-already-in-use") {
            msg = "Bu email allaqachon ro'yxatdan o'tgan. Login sahifasiga yo'naltirilmoqda...";
            showError(msg);
            setTimeout(() => { window.location.href = "./login.html"; }, 2000);
            return;
          } else if (error.code === "auth/invalid-email")       msg = "Noto'g'ri email format!";
          else if (error.code === "auth/weak-password")         msg = "Parol juda zaif!";
          else if (error.code === "auth/network-request-failed") msg = "Internet aloqasi yo'q!";

          showError(msg);
          signupBtn.disabled = false;
          signupBtn.textContent = "Ro'yxatdan o'tish";
        }
      };

      // Google Sign-up
      window.handleGoogleSignUp = async function () {
        hideAlerts();
        try {
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({ prompt: "select_account" });
          const result = await signInWithPopup(auth, provider);

          if (result && result.user) {
            // Google orqali kirganda verification shart emas
            sessionStorage.setItem("ziyo_verified", "true");
            showSuccess("✅ Google orqali muvaffaqiyatli kirdingiz! Yo'naltirilmoqda...");
            setTimeout(() => { window.location.href = "./dashboard.html"; }, 1000);
          }
        } catch (error) {
          if (
            error.code === "auth/popup-closed-by-user" ||
            error.code === "auth/cancelled-popup-request"
          ) return;

          let msg = "Google orqali kirib bo'lmadi!";
          if (error.code === "auth/popup-blocked")
            msg = "Popup bloklangan. Sayt uchun popupga ruxsat bering.";
          else if (error.code === "auth/account-exists-with-different-credential")
            msg = "Bu email bilan boshqa usulda hisob mavjud. Email/parol bilan kiring.";
          else if (error.code === "auth/network-request-failed")
            msg = "Internet aloqasi yo'q!";

          showError(msg);
        }
      };

      // Helpers
      function hideAlerts() {
        document.getElementById("errorAlert").style.display   = "none";
        document.getElementById("successAlert").style.display = "none";
        document.getElementById("warningAlert").style.display = "none";
      }
      function showError(msg) {
        const el = document.getElementById("errorAlert");
        el.textContent = msg;
        el.style.display = "block";
      }
      function showSuccess(msg) {
        const el = document.getElementById("successAlert");
        el.textContent = msg;
        el.style.display = "block";
      }

      document.getElementById("password").addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleSignup();
      });
    </script>

    <script src="https://unpkg.com/scrollreveal"></script>
    <script src="../JS/app.js"></script>
  </body>
</html>