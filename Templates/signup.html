<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZiyoAI — Sign Up</title>
    <link rel="website icon" type="png" href="../IMG/Logo/ZiyoAILogo.png" />
    <!-- Main CSS -->
    <link rel="stylesheet" href="../Static/auth.css" />
    <link rel="stylesheet" href="../CSS/main.css" />
    <!-- Font-Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <!-- Spinner -->
    <div class="spinner-wrapper">
      <div class="spinner-grow" role="status">
          <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <!-- Back to home -->
    <a class="back-home" href="../index.html"><i class="bi bi-chevron-left"></i></a>

    <div class="auth-container">
        <div class="main-section">
        <div class="nav-left login-logo">
          <img src="../IMG/Logo/ZiyoAILogo.png" alt="">
          <a class="navbar-brand"><h3 class="nav-title">iyoAI</h3></a>
        </div>
        <h4>Start Your Journey</h4>
        <p>Create your account to get started</p>
      </div>
      <div class="auth-card" id="login-form">

        <!-- Error Alert -->
        <div
          id="errorAlert"
          style="
            display: none;
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
          "
        ></div>

        <!-- Success Alert -->
        <div
          id="successAlert"
          style="
            display: none;
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
          "
        ></div>

        <!-- Warning Alert -->
        <div
          id="warningAlert"
          style="
            display: none;
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
          "
        ></div>

        <div>
          <!-- Signup.html -->
          <div class="input-box">
            <input
              type="text"
              id="username"
              name="username"
              placeholder=" "
              required
            />
            <label>Username</label>
          </div>

          <div class="input-box">
            <input
              type="email"
              id="email"
              name="email"
              placeholder=" "
              required
            />
            <label>Email</label>
          </div>

          <div class="input-box">
            <input
              type="password"
              id="password"
              name="password"
              placeholder=" "
              required
            />
            <label>Password</label>
          </div>

          <button
            class="btn-primary"
            type="button"
            id="signupBtn"
            onclick="handleSignup()"
          >
            Sign Up
          </button>

          <!-- Google Sign-in -->
          <div style="margin: 20px 0; text-align: center; color: #6b7280; font-size: 14px;">
            <span style="display: inline-block; width: 100%; position: relative;">
              <span style="background: white; padding: 0 10px; position: relative; z-index: 1;">or</span>
              <span style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #e5e7eb; z-index: 0;"></span>
            </span>
          </div>

          <button
            type="button"
            onclick="handleGoogleSignUp()"
            style="
              width: 100%;
              padding: 12px;
              background: white;
              border: 2px solid #e5e7eb;
              border-radius: 10px;
              cursor: pointer;
              font-size: 15px;
              font-weight: 600;
              color: #374151;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
              transition: all 0.3s ease;
            "
            onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'"
            onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'"
          >
            <svg width="20" height="20" viewBox="0 0 48 48">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
              <path fill="none" d="M0 0h48v48H0z"></path>
            </svg>
            Continue with Google
          </button>
        </div>

        <p class="switch-link">
          Already have an account? <a href="./login.html">Log In</a>
        </p>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        updateProfile,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        sendEmailVerification,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA_w0n84YFtUYZgZodCn52lfYiqkL6v1HM",
        authDomain: "zioai-96e9f.firebaseapp.com",
        projectId: "zioai-96e9f",
        storageBucket: "zioai-96e9f.firebasestorage.app",
        messagingSenderId: "766076125152",
        appId: "1:766076125152:web:9cd609efb7895386547585",
        measurementId: "G-2EDVXFZFHQ",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // Check if user is already logged in
      onAuthStateChanged(auth, (user) => {
        if (user && user.emailVerified) {
          // Faqat verified userlar dashboard ga o'tadi
          window.location.href = "./dashboard.html";
        }
      });

      // Email/Password Signup WITH VERIFICATION
      window.handleSignup = async function () {
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const signupBtn = document.getElementById("signupBtn");
        const errorAlert = document.getElementById("errorAlert");
        const successAlert = document.getElementById("successAlert");
        const warningAlert = document.getElementById("warningAlert");

        // Hide previous alerts
        errorAlert.style.display = "none";
        successAlert.style.display = "none";
        warningAlert.style.display = "none";

        // Validation
        if (!username || !email || !password) {
          showError("Please fill in all fields!");
          return;
        }

        // Email format validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showError("Please enter a valid email address!");
          return;
        }

        if (password.length < 6) {
          showError("Password must be at least 6 characters!");
          return;
        }

        // Show loading
        signupBtn.disabled = true;
        signupBtn.textContent = "Creating Account...";

        try {
          // Create user with Firebase
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );

          // Update user profile with username
          await updateProfile(userCredential.user, {
            displayName: username,
          });

          // YANGI: Email verification yuborish
          try {
            await sendEmailVerification(userCredential.user);
            
            // Success message with verification notice
            showWarning(
              `Tasdiqlash xati ${email}ga yuborildi.
• Inbox va Spam/Junk papkalarni tekshiring`
            );
          } catch (verificationError) {
            console.error("Verification send error:", verificationError);
            showWarning(
              `Account created but verification email failed to send. You can request a new verification email from the login page.`
            );
          }

          // Sign out user until they verify
          await auth.signOut();

          // Redirect to login after 7 seconds
          setTimeout(() => {
            window.location.href = "./login.html";
          }, 7000);

        } catch (error) {
          console.error("Signup error:", error);

          let errorMessage = "An error occurred!";

          if (error.code === "auth/email-already-in-use") {
            errorMessage = "This email is already registered. Redirecting to login...";
            showError(errorMessage);
            setTimeout(() => {
              window.location.href = "./login.html";
            }, 2000);
            return;
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "Invalid email format!";
          } else if (error.code === "auth/weak-password") {
            errorMessage = "Password is too weak!";
          } else if (error.code === "auth/network-request-failed") {
            errorMessage = "Network error. Please check your internet connection!";
          }

          showError(errorMessage);

          // Reset button
          signupBtn.disabled = false;
          signupBtn.textContent = "Sign Up";
        }
      };

      // Google Sign-up (no verification needed for Google)
      window.handleGoogleSignUp = async function () {
        const errorAlert = document.getElementById("errorAlert");
        const successAlert = document.getElementById("successAlert");
        
        errorAlert.style.display = "none";
        successAlert.style.display = "none";

        try {
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({
            prompt: 'select_account'
          });
          
          const result = await signInWithPopup(auth, provider);
          
          if (result && result.user) {
            showSuccess("Successfully signed in with Google! Redirecting...");
            
            setTimeout(() => {
              window.location.href = "./dashboard.html";
            }, 1000);
          }
        } catch (error) {
          console.error("Google sign-in error:", error);
          
          if (error.code === "auth/popup-closed-by-user" || 
              error.code === "auth/cancelled-popup-request") {
            return;
          }
          
          let errorMessage = "Failed to sign in with Google!";
          
          if (error.code === "auth/popup-blocked") {
            errorMessage = "Popup blocked. Please allow popups for this site.";
          } else if (error.code === "auth/account-exists-with-different-credential") {
            errorMessage = "An account already exists with this email. Please use email/password login.";
          } else if (error.code === "auth/network-request-failed") {
            errorMessage = "Network error. Please check your internet connection!";
          }
          
          showError(errorMessage);
        }
      };

      // Helper functions
      function showError(message) {
        const errorAlert = document.getElementById("errorAlert");
        errorAlert.textContent = message;
        errorAlert.style.display = "block";
      }

      function showSuccess(message) {
        const successAlert = document.getElementById("successAlert");
        successAlert.textContent = message;
        successAlert.style.display = "block";
      }

      function showWarning(message) {
        const warningAlert = document.getElementById("warningAlert");
        warningAlert.textContent = message;
        warningAlert.style.display = "block";
      }

      // Enter key support
      document
        .getElementById("password")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            handleSignup();
          }
        });
    </script>

    <script src="https://unpkg.com/scrollreveal"></script>
    <script src="../JS/app.js"></script>
  </body>
</html>