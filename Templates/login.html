<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZiyoAI â€” Login</title>
    <link rel="website icon" type="png" href="../IMG/Logo/ZiyoAILogo.png" />

    <!-- Main CSS -->
    <link rel="stylesheet" href="../Static/auth.css" />
    <link rel="stylesheet" href="../CSS/main.css" />
    <!-- Font-Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <!-- Spinner -->
    <div class="spinner-wrapper">
      <div class="spinner-grow" role="status">
          <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <!-- Back to home -->
    <a class="back-home" href="../index.html"><i class="bi bi-chevron-left"></i></a>

    <div class="auth-container">
      <div class="main-section">
        <div class="nav-left login-logo">
          <img src="../IMG/Logo/ZiyoAILogo.png" alt="">
          <a class="navbar-brand"><h3 class="nav-title">iyoAI</h3></a>
        </div>
        <h4>Xush kelibsiz</h4>
        <p>Oâ€˜rganishni davom ettirish uchun tizimga kiring</p>
      </div>

      <div class="auth-card">
        <!-- Error Alert -->
        <div
          id="errorAlert"
          style="
            display: none;
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
          "
        ></div>

        <!-- Success Alert -->
        <div
          id="successAlert"
          style="
            display: none;
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
          "
        ></div>

        <!-- Login Form -->
        <div id="loginForm">
          <!-- Login.html -->
          <div class="input-box">
            <input
              type="email"
              id="email"
              name="email"
              placeholder=" "
              required
            />
            <label>Email</label>
          </div>

          <div class="input-box">
            <input
              type="password"
              id="password"
              name="password"
              placeholder=" "
              required
            />
            <label>Parol</label>
          </div>

          <button
            class="btn-primary"
            type="button"
            id="loginBtn"
            onclick="handleLogin()"
          >
            Kirish
          </button>

          <!-- Resend Verification Button -->
          <button
            type="button"
            id="resendVerificationBtn"
            style="
              display: none;
              width: 100%;
              margin-top: 10px;
              padding: 10px;
              background: #f59e0b;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            "
            onclick="resendVerification()"
          >
            ðŸ“§ Tasdiqlash elektron pochta xabarini qayta yuborish
          </button>

          <!-- Google Sign-in -->
          <div style="margin: 20px 0; text-align: center; color: #6b7280; font-size: 14px;">
            <span style="display: inline-block; width: 100%; position: relative;">
              <span style="background: white; padding: 0 10px; position: relative; z-index: 1;">yoki</span>
              <span style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #e5e7eb; z-index: 0;"></span>
            </span>
          </div>

          <button
            type="button"
            onclick="handleGoogleSignIn()"
            style="
              width: 100%;
              padding: 12px;
              background: white;
              border: 2px solid #e5e7eb;
              border-radius: 10px;
              cursor: pointer;
              font-size: 15px;
              font-weight: 600;
              color: #374151;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
              transition: all 0.3s ease;
            "
            onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'"
            onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'"
          >
            <svg width="20" height="20" viewBox="0 0 48 48">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
              <path fill="none" d="M0 0h48v48H0z"></path>
            </svg>
            Google orqali davom etish
          </button>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgotPasswordForm" style="display: none;">
          <div style="text-align: center; margin-bottom: 20px;">
            <h5 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 8px;">
              Parolni qayta o'rnatish
            </h5>
            <p style="font-size: 14px; color: #6B7280;">
              Email manzilingizni kiriting va biz sizga parolni tiklash havolasini yuboramiz.
            </p>
          </div>

          <div class="input-box">
            <input
              type="email"
              id="resetEmail"
              name="resetEmail"
              placeholder=" "
              required
            />
            <label>Email</label>
          </div>

          <button
            class="btn-primary"
            type="button"
            id="resetBtn"
            onclick="handlePasswordReset()"
          >
            Tiklash havolasini yuborish
          </button>

          <button
            type="button"
            onclick="showLoginForm()"
            style="
              width: 100%;
              margin-top: 12px;
              padding: 12px;
              background: white;
              border: 1px solid #D1D5DB;
              border-radius: 8px;
              color: #374151;
              font-size: 15px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.2s ease;
            "
            onmouseover="this.style.background='#F9FAFB'"
            onmouseout="this.style.background='white'"
          >
            Kirish bo'limiga qaytish
          </button>
        </div>

        <p class="switch-link">
          Hisobingiz yo'qmi? <a href="./signup.html">Ro'yxatdan o'tish</a>
        </p>
        
          <!-- Forgot Password Link -->
          <div style="text-align: center;">
            <a 
              href="#" 
              onclick="showForgotPassword(); return false;"
              style="
                color: #4F46E5;
                text-decoration: none;
                font-size: 14px;
                font-weight: 500;
              "
            >
              Parolni esdan chiqardingizmi?
            </a>
          </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        sendEmailVerification,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA_w0n84YFtUYZgZodCn52lfYiqkL6v1HM",
        authDomain: "zioai-96e9f.firebaseapp.com",
        projectId: "zioai-96e9f",
        storageBucket: "zioai-96e9f.firebasestorage.app",
        messagingSenderId: "766076125152",
        appId: "1:766076125152:web:9cd609efb7895386547585",
        measurementId: "G-2EDVXFZFHQ",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // FIXED: Prevent infinite redirect loop
      let isRedirecting = false;
      
      onAuthStateChanged(auth, (user) => {
        // TEMPORARY: Skip verification check for testing
        if (user && !isRedirecting) {
          // TODO: Add back: && user.emailVerified
          isRedirecting = true;
          window.location.href = "./dashboard.html";
        }
      });

      // ============================================
      // CHECK FOR VERIFICATION SUCCESS
      // ============================================
      window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('verified') === 'true') {
          showSuccess('âœ… Email verified successfully! Please log in to continue.');
          
          // Remove the parameter from URL
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      });

      // Temporary email/password storage for resend
      let tempLoginData = null;

      // ============================================
      // SHOW/HIDE FORMS
      // ============================================
      window.showForgotPassword = function() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('forgotPasswordForm').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';
        document.getElementById('successAlert').style.display = 'none';
      };

      window.showLoginForm = function() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('forgotPasswordForm').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'none';
        document.getElementById('successAlert').style.display = 'none';
      };

      // ============================================
      // PASSWORD RESET HANDLER
      // ============================================
      window.handlePasswordReset = async function() {
        const email = document.getElementById('resetEmail').value.trim();
        const resetBtn = document.getElementById('resetBtn');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');

        errorAlert.style.display = 'none';
        successAlert.style.display = 'none';

        if (!email) {
          showError('Please enter your email address!');
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showError('Please enter a valid email address!');
          return;
        }

        resetBtn.disabled = true;
        resetBtn.textContent = 'Sending...';

        try {
          // IMPORTANT: Firebase will use the URL configured in your Firebase Console
          // Make sure to add this URL in: Firebase Console > Authentication > Templates > Password reset
          // The URL should point to: https://your-domain.com/Templates/reset-password.html
          
          const actionCodeSettings = {
            url: window.location.origin + '/Templates/reset-password.html',
            handleCodeInApp: true
          };
          
          await sendPasswordResetEmail(auth, email, actionCodeSettings);
          
          showSuccess('âœ… Password reset link sent! Please check your email (and spam folder).');
          
          // Clear the input
          document.getElementById('resetEmail').value = '';
          
          // Go back to login after 3 seconds
          setTimeout(() => {
            showLoginForm();
          }, 3000);

        } catch (error) {
          console.error('Password reset error:', error);

          let errorMessage = 'Failed to send reset email!';

          if (error.code === 'auth/user-not-found') {
            errorMessage = 'No account found with this email address!';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email format!';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'Too many requests. Please try again later.';
          } else if (error.code === 'auth/network-request-failed') {
            errorMessage = 'Network error. Please check your internet connection!';
          } else if (error.code === 'auth/unauthorized-continue-uri') {
            errorMessage = 'Please configure the password reset URL in Firebase Console.';
            console.error('IMPORTANT: Add this URL to authorized domains in Firebase Console:', window.location.origin);
          }

          showError(errorMessage);
        } finally {
          resetBtn.disabled = false;
          resetBtn.textContent = 'Send Reset Link';
        }
      };

      // Email/Password Login
      window.handleLogin = async function () {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const loginBtn = document.getElementById("loginBtn");
        const errorAlert = document.getElementById("errorAlert");
        const successAlert = document.getElementById("successAlert");
        const resendBtn = document.getElementById("resendVerificationBtn");

        errorAlert.style.display = "none";
        successAlert.style.display = "none";
        resendBtn.style.display = "none";

        if (!email || !password) {
          showError("Please fill in all fields!");
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showError("Please enter a valid email address!");
          return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = "Logging in...";

        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          
          // TEMPORARY: Skip email verification check for testing
          // TODO: Remove this after email verification is working
          
          // UNCOMMENT THIS to require email verification:
          /*
          if (!userCredential.user.emailVerified) {
            tempLoginData = { email, password };
            resendBtn.style.display = "block";
            
            showError(`âš ï¸ Email not verified!

Please check your email inbox (and spam folder) for the verification link.

If you didn't receive it, click "Resend Verification Email" button below.`);
            
            await auth.signOut();
            loginBtn.disabled = false;
            loginBtn.textContent = "Log In";
            return;
          }
          */
          
          // Success
          showSuccess("âœ… Login successful! Redirecting...");
          isRedirecting = true;
          
          setTimeout(() => {
            window.location.href = "./dashboard.html";
          }, 1000);
        } catch (error) {
          console.error("Login error:", error);

          let errorMessage = "An error occurred!";

          if (error.code === "auth/user-not-found") {
            errorMessage = "No account found with this email. Please sign up first!";
          } else if (error.code === "auth/wrong-password") {
            errorMessage = "Incorrect password!";
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "Invalid email format!";
          } else if (error.code === "auth/invalid-credential") {
            errorMessage = "Invalid email or password!";
          } else if (error.code === "auth/too-many-requests") {
            errorMessage = "Too many failed attempts. Please try again later.";
          } else if (error.code === "auth/network-request-failed") {
            errorMessage = "Network error. Please check your internet connection!";
          }

          showError(errorMessage);
          loginBtn.disabled = false;
          loginBtn.textContent = "Log In";
        }
      };

      // Resend Verification Email
      window.resendVerification = async function () {
        const resendBtn = document.getElementById("resendVerificationBtn");
        
        if (!tempLoginData) {
          showError("Please log in again to resend verification email.");
          return;
        }
        
        resendBtn.disabled = true;
        resendBtn.textContent = "Sending...";
        
        try {
          // Sign in temporarily to send verification
          const userCredential = await signInWithEmailAndPassword(
            auth, 
            tempLoginData.email, 
            tempLoginData.password
          );
          
          await sendEmailVerification(userCredential.user);
          await auth.signOut();
          
          showSuccess("âœ… Verification email sent! Please check your inbox (and spam folder).");
          
          // Reset button after 3 seconds
          setTimeout(() => {
            resendBtn.disabled = false;
            resendBtn.textContent = "ðŸ“§ Resend Verification Email";
          }, 3000);
        } catch (error) {
          console.error("Resend verification error:", error);
          showError("Failed to resend verification email. Please try again.");
          resendBtn.disabled = false;
          resendBtn.textContent = "ðŸ“§ Resend Verification Email";
        }
      };

      // FIXED: Google Sign-in - only existing users
      window.handleGoogleSignIn = async function () {
        const errorAlert = document.getElementById("errorAlert");
        const successAlert = document.getElementById("successAlert");
        
        errorAlert.style.display = "none";
        successAlert.style.display = "none";

        try {
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({
            prompt: 'select_account'
          });
          
          const result = await signInWithPopup(auth, provider);
          
          if (result && result.user) {
            // Check if this is a NEW user
            const isNewUser = result.user.metadata.creationTime === result.user.metadata.lastSignInTime;
            
            if (isNewUser) {
              // Delete new user
              await result.user.delete();
              showError("No account found with this Google account. Please sign up first!");
              return;
            }
            
            // Existing user - allow login
            showSuccess("âœ… Successfully signed in! Redirecting...");
            isRedirecting = true;
            
            setTimeout(() => {
              window.location.href = "./dashboard.html";
            }, 1000);
          }
        } catch (error) {
          console.error("Google sign-in error:", error);
          
          if (error.code === "auth/popup-closed-by-user" || 
              error.code === "auth/cancelled-popup-request") {
            return;
          }
          
          let errorMessage = "Failed to sign in with Google!";
          
          if (error.code === "auth/popup-blocked") {
            errorMessage = "Popup blocked. Please allow popups for this site.";
          } else if (error.code === "auth/account-exists-with-different-credential") {
            errorMessage = "An account already exists with this email. Please use email/password login.";
          } else if (error.code === "auth/network-request-failed") {
            errorMessage = "Network error. Please check your internet connection!";
          }
          
          showError(errorMessage);
        }
      };

      // Helper functions
      function showError(message) {
        const errorAlert = document.getElementById("errorAlert");
        errorAlert.innerHTML = message.replace(/\n/g, '<br>');
        errorAlert.style.display = "block";
        errorAlert.style.whiteSpace = "pre-line";
      }

      function showSuccess(message) {
        const successAlert = document.getElementById("successAlert");
        successAlert.textContent = message;
        successAlert.style.display = "block";
      }

      // Enter key support
      document.getElementById("password").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          handleLogin();
        }
      });

      // Enter key support for reset email
      document.addEventListener('DOMContentLoaded', () => {
        const resetEmailInput = document.getElementById('resetEmail');
        if (resetEmailInput) {
          resetEmailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              handlePasswordReset();
            }
          });
        }
      });
    </script>

    <script src="https://unpkg.com/scrollreveal"></script>
    <script src="../JS/app.js"></script>
  </body>
</html>