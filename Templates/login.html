<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZiyoAI â€” Login</title>
    <link rel="website icon" type="png" href="../IMG/Logo/ZiyoAILogo.png" />
    <link rel="stylesheet" href="../Static/auth.css" />
    <link rel="stylesheet" href="../CSS/main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  </head>
  <body>
    <div class="spinner-wrapper">
      <div class="spinner-grow" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <a class="back-home" href="../index.html"><i class="bi bi-chevron-left"></i></a>

    <div class="auth-container">
      <div class="main-section">
        <div class="nav-left login-logo">
          <img src="../IMG/Logo/ZiyoAILogo.png" alt="">
          <a class="navbar-brand"><h3 class="nav-title">iyoAI</h3></a>
        </div>
        <h4>Xush kelibsiz</h4>
        <p>O'rganishni davom ettirish uchun tizimga kiring</p>
      </div>

      <div class="auth-card">
        <div id="errorAlert"   style="display:none; background:#fee; color:#c33; padding:12px; border-radius:8px; margin-bottom:15px; font-size:14px;"></div>
        <div id="successAlert" style="display:none; background:#efe; color:#3c3; padding:12px; border-radius:8px; margin-bottom:15px; font-size:14px;"></div>

        <!-- LOGIN FORM -->
        <div id="loginForm">
          <div class="input-box">
            <input type="email" id="email" placeholder=" " required />
            <label>Email</label>
          </div>
          <div class="input-box">
            <input type="password" id="password" placeholder=" " required />
            <label>Parol</label>
          </div>

          <button class="btn-primary" type="button" id="loginBtn">Kirish</button>

          <button type="button" id="resendVerificationBtn"
            style="display:none; width:100%; margin-top:10px; padding:10px; background:#f59e0b; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
            ðŸ“§ Tasdiqlash elektron pochta xabarini qayta yuborish
          </button>

          <div style="margin:20px 0; text-align:center; color:#6b7280; font-size:14px;">
            <span style="display:inline-block; width:100%; position:relative;">
              <span style="background:white; padding:0 10px; position:relative; z-index:1;">yoki</span>
              <span style="position:absolute; top:50%; left:0; right:0; height:1px; background:#e5e7eb; z-index:0;"></span>
            </span>
          </div>

          <button type="button" id="googleBtn"
            style="width:100%; padding:12px; background:white; border:2px solid #e5e7eb; border-radius:10px; cursor:pointer; font-size:15px; font-weight:600; color:#374151; display:flex; align-items:center; justify-content:center; gap:10px; transition:all 0.3s ease;"
            onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'"
            onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
            <svg width="20" height="20" viewBox="0 0 48 48">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
            </svg>
            Google orqali davom etish
          </button>
        </div>

        <!-- FORGOT PASSWORD FORM -->
        <div id="forgotPasswordForm" style="display:none;">
          <div style="text-align:center; margin-bottom:20px;">
            <div style="width:56px; height:56px; background:linear-gradient(135deg,#5d9cf5,#2caa9a); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 14px;">
              <i class="bi bi-key-fill" style="font-size:24px; color:white;"></i>
            </div>
            <h5 style="font-size:18px; font-weight:700; color:#111827; margin-bottom:8px;">Parolni tiklash</h5>
            <p style="font-size:14px; color:#6b7280; line-height:1.5;">
              Email manzilingizni kiriting, biz sizga tiklash havolasi yuboramiz.
            </p>
          </div>

          <div class="input-box">
            <input type="email" id="resetEmail" placeholder=" " required />
            <label>Email</label>
          </div>

          <button class="btn-primary" type="button" id="resetBtn">
            <i class="bi bi-send me-2"></i>Tiklash havolasini yuborish
          </button>

          <button type="button" id="backToLoginBtn"
            style="width:100%; margin-top:12px; padding:12px; background:white; border:1px solid #d1d5db; border-radius:8px; color:#374151; font-size:15px; font-weight:500; cursor:pointer;"
            onmouseover="this.style.background='#f9fafb'"
            onmouseout="this.style.background='white'">
            <i class="bi bi-arrow-left me-1"></i> Kirish bo'limiga qaytish
          </button>
        </div>

        <p class="switch-link">
          Hisobingiz yo'qmi? <a href="./signup.html">Ro'yxatdan o'tish</a>
        </p>
        <div style="text-align:center;">
          <a href="#" id="forgotPasswordLink" style="color:#4F46E5; text-decoration:none; font-size:14px; font-weight:500;">
            Parolni esdan chiqardingizmi?
          </a>
        </div>
      </div>
    </div>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        sendEmailVerification,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // =============================================
      // âš™ï¸ SOZLAMALAR â€” O'zgartiring!
      // =============================================
      const EMAILJS_PUBLIC_KEY  = "EOVuFtynDt_B3cg5v";
      const EMAILJS_SERVICE_ID  = "service_o80q31v";
      const EMAILJS_RESET_TEMPLATE_ID = "template_ilt1w2j"; // Reset uchun alohida template
      // =============================================

      emailjs.init(EMAILJS_PUBLIC_KEY);

      const firebaseConfig = {
        apiKey: "AIzaSyA_w0n84YFtUYZgZodCn52lfYiqkL6v1HM",
        authDomain: "zioai-96e9f.firebaseapp.com",
        projectId: "zioai-96e9f",
        storageBucket: "zioai-96e9f.firebasestorage.app",
        messagingSenderId: "766076125152",
        appId: "1:766076125152:web:9cd609efb7895386547585",
        measurementId: "G-2EDVXFZFHQ",
      };

      const app  = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      let isRedirecting = false;
      let tempLoginData = null;

      // Auth state
      onAuthStateChanged(auth, (user) => {
        if (user && !isRedirecting) {
          isRedirecting = true;
          window.location.href = "./dashboard.html";
        }
      });

      // Verified URL param
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get("verified") === "true") {
        showSuccess("âœ… Email tasdiqlandi! Tizimga kiring.");
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // ============================================
      // HELPERS
      // ============================================
      function hideAlerts() {
        document.getElementById("errorAlert").style.display   = "none";
        document.getElementById("successAlert").style.display = "none";
      }
      function showError(msg) {
        const el = document.getElementById("errorAlert");
        el.innerHTML = msg.replace(/\n/g, "<br>");
        el.style.display = "block";
      }
      function showSuccess(msg) {
        const el = document.getElementById("successAlert");
        el.textContent = msg;
        el.style.display = "block";
      }
      function showForgotPassword() {
        document.getElementById("loginForm").style.display          = "none";
        document.getElementById("forgotPasswordForm").style.display = "block";
        hideAlerts();
      }
      function showLoginForm() {
        document.getElementById("loginForm").style.display          = "block";
        document.getElementById("forgotPasswordForm").style.display = "none";
        hideAlerts();
      }

      // ============================================
      // EVENT LISTENERS â€” onclick o'rniga
      // ============================================
      document.getElementById("forgotPasswordLink").addEventListener("click", (e) => {
        e.preventDefault();
        showForgotPassword();
      });
      document.getElementById("backToLoginBtn").addEventListener("click", showLoginForm);
      document.getElementById("loginBtn").addEventListener("click", handleLogin);
      document.getElementById("resetBtn").addEventListener("click", handlePasswordReset);
      document.getElementById("googleBtn").addEventListener("click", handleGoogleSignIn);
      document.getElementById("resendVerificationBtn").addEventListener("click", resendVerification);
      document.getElementById("password").addEventListener("keypress", (e) => { if (e.key === "Enter") handleLogin(); });
      document.getElementById("resetEmail").addEventListener("keypress", (e) => { if (e.key === "Enter") handlePasswordReset(); });

      // ============================================
      // LOGIN
      // ============================================
      async function handleLogin() {
        const email     = document.getElementById("email").value.trim();
        const password  = document.getElementById("password").value;
        const loginBtn  = document.getElementById("loginBtn");
        const resendBtn = document.getElementById("resendVerificationBtn");

        hideAlerts();
        resendBtn.style.display = "none";

        if (!email || !password)                              { showError("Barcha maydonlarni to'ldiring!"); return; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))       { showError("To'g'ri email kiriting!"); return; }

        loginBtn.disabled     = true;
        loginBtn.textContent  = "Kirilmoqda...";

        try {
          await signInWithEmailAndPassword(auth, email, password);
          showSuccess("âœ… Muvaffaqiyatli kirdingiz! Yo'naltirilmoqda...");
          isRedirecting = true;
          setTimeout(() => { window.location.href = "./dashboard.html"; }, 1000);
        } catch (error) {
          let msg = "Xatolik yuz berdi!";
          if      (error.code === "auth/user-not-found")         msg = "Bu email bilan hisob topilmadi!";
          else if (error.code === "auth/wrong-password")         msg = "Noto'g'ri parol!";
          else if (error.code === "auth/invalid-credential")     msg = "Email yoki parol noto'g'ri!";
          else if (error.code === "auth/too-many-requests")      msg = "Juda ko'p urinish. Keyinroq urinib ko'ring.";
          else if (error.code === "auth/network-request-failed") msg = "Internet aloqasi yo'q!";
          showError(msg);
          loginBtn.disabled    = false;
          loginBtn.textContent = "Kirish";
        }
      }

      // ============================================
      // PASSWORD RESET
      // ============================================
      async function handlePasswordReset() {
        const email    = document.getElementById("resetEmail").value.trim();
        const resetBtn = document.getElementById("resetBtn");

        hideAlerts();

        if (!email)                                        { showError("Iltimos, email manzilingizni kiriting!"); return; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))   { showError("Iltimos, to'g'ri email kiriting!"); return; }

        resetBtn.disabled   = true;
        resetBtn.innerHTML  = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Yuborilmoqda...';

        try {
          const actionCodeSettings = {
            url: window.location.origin + "/Templates/reset-password.html",
            handleCodeInApp: true,
          };

          // Firebase reset email yuboradi (link bilan)
          await sendPasswordResetEmail(auth, email, actionCodeSettings);

          // EmailJS orqali chiroyli email yuboradi
          const userName = email.split("@")[0];
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_RESET_TEMPLATE_ID, {
            to_name:     userName,
            to_email:    email,
            reset_url:   window.location.origin + "/Templates/reset-password.html",
            app_name:    "ZiyoAI",
            expire_time: "10 daqiqa",
          });

          showSuccess("âœ… Tiklash havolasi " + email + " ga yuborildi! Inbox va Spam papkalarni tekshiring.");
          document.getElementById("resetEmail").value = "";
          setTimeout(showLoginForm, 4000);

        } catch (error) {
          let msg = "Email yuborishda xatolik!";
          if      (error.code === "auth/user-not-found")         msg = "Bu email bilan hisob topilmadi!";
          else if (error.code === "auth/invalid-email")          msg = "Noto'g'ri email format!";
          else if (error.code === "auth/too-many-requests")      msg = "Juda ko'p urinish. Keyinroq urinib ko'ring.";
          else if (error.code === "auth/network-request-failed") msg = "Internet aloqasi yo'q!";
          showError(msg);
        } finally {
          resetBtn.disabled  = false;
          resetBtn.innerHTML = '<i class="bi bi-send me-2"></i>Tiklash havolasini yuborish';
        }
      }

      // ============================================
      // RESEND VERIFICATION
      // ============================================
      async function resendVerification() {
        const resendBtn = document.getElementById("resendVerificationBtn");
        if (!tempLoginData) { showError("Qayta kirish uchun login qiling."); return; }
        resendBtn.disabled    = true;
        resendBtn.textContent = "Yuborilmoqda...";
        try {
          const uc = await signInWithEmailAndPassword(auth, tempLoginData.email, tempLoginData.password);
          await sendEmailVerification(uc.user);
          await auth.signOut();
          showSuccess("âœ… Tasdiqlash emaili yuborildi!");
          setTimeout(() => {
            resendBtn.disabled    = false;
            resendBtn.textContent = "ðŸ“§ Tasdiqlash elektron pochta xabarini qayta yuborish";
          }, 3000);
        } catch {
          showError("Qayta yuborishda xatolik.");
          resendBtn.disabled    = false;
          resendBtn.textContent = "ðŸ“§ Tasdiqlash elektron pochta xabarini qayta yuborish";
        }
      }

      // ============================================
      // GOOGLE SIGN-IN
      // ============================================
      async function handleGoogleSignIn() {
        hideAlerts();
        try {
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({ prompt: "select_account" });
          const result = await signInWithPopup(auth, provider);
          if (result?.user) {
            const isNew = result.user.metadata.creationTime === result.user.metadata.lastSignInTime;
            if (isNew) {
              await result.user.delete();
              showError("Bu Google hisob bilan ro'yxatdan o'tilmagan. Avval ro'yxatdan o'ting!");
              return;
            }
            showSuccess("âœ… Google orqali muvaffaqiyatli kirdingiz!");
            isRedirecting = true;
            setTimeout(() => { window.location.href = "./dashboard.html"; }, 1000);
          }
        } catch (error) {
          if (error.code === "auth/popup-closed-by-user" || error.code === "auth/cancelled-popup-request") return;
          let msg = "Google orqali kirib bo'lmadi!";
          if (error.code === "auth/popup-blocked")             msg = "Popup bloklangan. Sayt uchun popupga ruxsat bering.";
          else if (error.code === "auth/network-request-failed") msg = "Internet aloqasi yo'q!";
          showError(msg);
        }
      }
    </script>

    <script src="https://unpkg.com/scrollreveal"></script>
    <script src="../JS/app.js"></script>
  </body>
</html>